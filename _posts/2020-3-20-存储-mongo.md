---
layout: post
title: "MongoDB"
subtitle: ''
comments: false
author: "Gump"
header-style: text
date: 2020-3-20 20:30:21 +0800
tags:
    - 存储
    - 笔记
---

# Mongo

## 典型用途

- 附近的人

  

## 概念

- Database 同关系型数据库db
- Collections 同关系型数据库 table
- Document 同关系型数据 table的一行
- 索引 类似关系型数据索引 index,采用B- Tree

## 连接

mongo服务默认是用长连接，服务端不会主动关闭连接；客户端在建立连接后一定要注意主动释放

## 集群

### Replication 

**定义**

> A *replica set* in MongoDB is a group of [`mongod`](https://docs.mongodb.com/manual/reference/program/mongod/#bin.mongod) processes that maintain the same data set. Replica sets provide redundancy and [high availability](https://docs.mongodb.com/manual/reference/glossary/#term-high-availability), and are the basis for all production deployments.

**集群初始化配置**

```javascript
rs.initiate( {
   _id : "rs0",
   members: [
      { _id: 0, host: "mongodb0.example.net:27017" },
      { _id: 1, host: "mongodb1.example.net:27017" },
      { _id: 2, host: "mongodb2.example.net:27017" }
   ]
})
```

**新增一台机器**

```javascript
rs.add( { host: "mongodb3.example.net:27017", priority: 0, votes: 0 } )
```

**移除一台机器**

```javascript
//移除mongodb2
cfg = rs.conf()
cfg.members.splice(2,1)
rs.reconfig(cfg)
```

### Sharding

**定义**

> [Sharding](https://docs.mongodb.com/manual/reference/glossary/#term-sharding) is a method for distributing data across multiple machines. MongoDB uses sharding to support deployments with very large data sets and high throughput operations.

**组成**

- [shard](https://docs.mongodb.com/manual/core/sharded-cluster-shards/): Each shard contains a subset of the sharded data. Each shard can be deployed as a [replica set](https://docs.mongodb.com/manual/reference/glossary/#term-replica-set).
- [mongos](https://docs.mongodb.com/manual/core/sharded-cluster-query-router/): The `mongos` acts as a query router, providing an interface between client applications and the sharded cluster.
- [config servers](https://docs.mongodb.com/manual/core/sharded-cluster-config-servers/): Config servers store metadata and configuration settings for the cluster. As of MongoDB 3.4, config servers must be deployed as a replica set (CSRS).

MongoDB shards data at the [collection](https://docs.mongodb.com/manual/reference/glossary/#term-collection) level, distributing the collection data across the shards in the cluster.

**Sharding Strategy**

- ### Hashed Sharding

  Hashed Sharding involves computing a hash of the shard key field’s value. Each [chunk](https://docs.mongodb.com/manual/reference/glossary/#term-chunk) is then assigned a range based on the hashed shard key values.

- ### Ranged Sharding

  Ranged sharding involves dividing data into ranges based on the shard key values. Each [chunk](https://docs.mongodb.com/manual/reference/glossary/#term-chunk) is then assigned a range based on the shard key values.